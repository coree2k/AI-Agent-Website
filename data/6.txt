### n8n과 Perplexity Deep Search를 활용하여 매월 자동으로 공정거래위원회의 하도급 관련 정책과 규제를 리서치하고 분석 리포트를 생성하는 시스템 구축 가이드입니다. <br> 최신 정책 동향을 자동으로 수집하고 실무 체크리스트까지 제공합니다.

## 목차

- [시스템 개요](#시스템-개요)
- [사전 준비사항](#사전-준비사항)
- [API 설정](#api-설정)
- [n8n 워크플로우 구축](#n8n-워크플로우-구축)
- [고급 활용 팁](#고급-활용-팁)
- [문제 해결](#문제-해결)

## 시스템 개요

이 가이드에서는 매월 자동으로 공정위의 하도급 관련 최신 정책과 규제를 리서치하고, 구조화된 분석 리포트를 생성하여 Airtable에 저장하고 이메일로 발송하는 시스템을 구축합니다.

### 워크플로우 구조

> &nbsp;&nbsp;&nbsp; **1. Schedule 설정 (매월)** → **2. 공정위 하도급 관련 Research AI Agent** → **3. Research 결과 저장 (Airtable)** → **4. Research 결과 메일 자동 발송**

![워크플로우 구조](./n8n_Source/06/2.%20WF.png)

<br>

1. **Schedule 설정 (매월)**:
   - Schedule Trigger (월간 자동 실행)

2. **공정위 하도급 관련 Research AI Agent (Perplexity Deep Search Tool 활용)**:
   - AI Agent (리서치 조율 및 분석)
   - OpenAI Chat Model (GPT-4.1-mini)
   - Simple Memory (세션 기록)
   - Research (Perplexity) (심층 검색)
   - Structured Output Parser (JSON 출력)

3. **Research 결과 저장 (Airtable)**:
   - Create a record (Airtable 데이터베이스 기록)

4. **Research 결과 메일 자동 발송**:
   - Send a message (Gmail 이메일 발송)

### 주요 기능

- 매월 자동 실행되는 스케줄링
- Perplexity Deep Search를 활용한 심층 리서치
- 공정위 공식 자료 우선 참조
- 3-5개 주요 정책 자동 분석
- 영향도, 규제 방향, 시행 시점 분류
- 실무 체크리스트 자동 생성
- Airtable 자동 기록 및 이메일 발송

## 사전 준비사항

- n8n 설치 및 실행 (Cloud 또는 Self-hosted)
- OpenAI API 키 (GPT-4.1-mini 사용)
- Perplexity API 키
- Airtable 계정 및 Personal Access Token
- Gmail 계정 (이메일 발송용)

## API 설정

### 1. OpenAI API 설정

1. [OpenAI Platform](https://platform.openai.com/)에서 API 키 발급

2. **n8n에서 설정**:
   - OpenAI API Credentials 추가
   - GPT-4.1-mini 모델 선택

### 2. Perplexity API 설정

1. [Perplexity](https://www.perplexity.ai/)에서 API 키 발급

2. **n8n에서 설정**:
   - Perplexity API Credentials 추가
   - Search Recency: month (최근 1개월)

### 3. Airtable API 설정

1. [Airtable](https://airtable.com/)에서 Personal Access Token 발급

2. **Base 및 Table 생성**:
   - Base: Realestate-research (또는 원하는 이름)
   - Table: realestate-research
   - Fields: Headline, Date, Research, Source

3. **n8n에서 설정**:
   - Airtable Personal Access Token 추가
   - Base ID 및 Table ID 확인

### 4. Gmail API 설정

1. [Google Cloud Console](https://console.cloud.google.com/)에서 Gmail API 활성화

2. **OAuth 2.0 설정**:
   - OAuth 동의 화면 구성
   - Gmail API 범위 추가

3. **n8n에서 설정**:
   - Gmail OAuth2 계정 연결

## n8n 워크플로우 구축

### 1. 스케줄 트리거 설정 (매월)

**Schedule Trigger 노드 추가**

- **Rule**: Interval
- **Interval**: Months (매월)
- **기능**: 매월 자동으로 워크플로우 실행

### 2. AI Agent 설정 (리서치 코디네이터)

**AI Agent 노드 추가**

**기본 설정**:
- Prompt Type: Define
- Text: `대한민국 '공정거래위원회'에서 추진하거나 규제하는 하도급 관련 정책/규제 리서치를 해줘`
- Has Output Parser: true
- Model: OpenAI Chat Model 연결
- Memory: Simple Memory 연결
- Tools: Research (Perplexity) 연결
- Output Parser: Structured Output Parser 연결

**System Message** (영어):

```
You are a meticulous Korean Fair Trade & Subcontracting Policy Research Agent.
Your only external capability is the "Research" tool (returns excerpts + URLs).

TASK

Identify the 3-5 most consequential Korean subcontracting policy / regulatory actions or proposals by the Fair Trade Commission (FTC/공정거래위원회) announced or advanced within the last 30 days.
• Today is {{ $today.format('yyyy-MM-dd') }}
Analyse how each item could impact subcontracting relationships, compliance obligations, and business operations over the next 6-12 months.

────────────────────────────────────────
INFORMATION-GATHERING RULES (EN)

Make exactly ONE (1) Research call.
Build one Korean query in this pattern:
"공정거래위원회 하도급" OR "하도급법" OR "하도급 거래" OR
"원사업자 의무" OR "수급사업자 보호" OR "하도급 대금" OR
"부당특약 금지" OR "기술자료 요구 제한" OR
"하도급 분쟁" OR "표준하도급계약서" OR
"하도급 검사" OR "공정거래위원회 제재"

예시 최종 문자열

Extract more than 10 distinct Korean sources (공정위 공식자료·법제처·산업언론·경제지).

────────────────────────────────────────
ANALYSIS & SYNTHESIS RULES

Cross-check facts; flag discrepancies.
For each 정책/규제, classify:
— Impact strength: High / Medium / Low
— Compliance direction: 규제강화 / 규제완화 / 중립
— Affected parties: 원사업자 / 수급사업자 / 양측
Prioritise items by expected operational impact.

────────────────────────────────────────
OUTPUT JSON — EXACT SHAPE REQUIRED
Return nothing except a single JSON object with three string fields:

{
  "headline": "<HEADLINE>",
  "research": "<MARKDOWN_BODY>",
  "sources": "<NUMBERED_SOURCE_LIST>"
}

<HEADLINE>
<전체 리서치 내용에 대한 헤드라인 한줄>

<MARKDOWN_BODY> (한국어·불릿 포맷)

# 최근 공정거래위원회 하도급 정책·규제 브리핑  
_Last updated: <YYYY-MM-DD>_

## 요약 한줄
<가장 영향력 높은 변화 요약>

## 정책별 상세 분석

- **정책·규제:** <이름>  
  • **시행/진행 단계:** 법 개정 / 시행령 발표 / 지침 제정 / 심사 착수 등  
  • **영향 강도:** High / Medium / Low  
  • **규제 방향:** 규제강화 / 규제완화 / 중립  
  • **영향 대상:** 원사업자 / 수급사업자 / 양측  
  • **영향 시점:** 즉시 / 3–6M / >6M  
  • **근거:** (see #3)  
  • **요약 설명:** 1-2문장으로 핵심 메커니즘

- **정책·규제:** <이름>  
  • … (위와 동일 형식 반복)

### 추가 설명
- **규제 메커니즘:** 하도급법 개정·지침 변경이 계약관행·대금지급·분쟁해결에 미치는 구체적 경로 (2–3문단)
- **업종·규모별 차별화:** 제조업 vs 건설업 vs IT, 대기업 vs 중소기업 등
- **제재·처벌 동향:** 최근 과징금·시정명령 사례 및 경향

## 실무 체크리스트
- **원사업자 준수사항:** …  
- **수급사업자 권리보호:** …  
- **계약서·증빙 관리:** …

<NUMBERED_SOURCE_LIST>

1. [제목] — URL
…

(인라인 인용 예: "…서면발급 의무 위반 시 과징금 부과 (see #2)")

────────────────────────────────────────
STYLE GUIDE (한국어)

1,500–2,000 단어 내외
법·제도 용어는 원어 그대로 유지 (하도급법, 원사업자, 수급사업자 등)
수치·인용 임의 생성 금지, 불확실하면 "n/a"
공정위 공식 발표 자료 우선 참조

────────────────────────────────────────
```

### 3. AI 모델 및 도구 설정

#### (1) OpenAI Chat Model

**OpenAI Chat Model 노드 추가**

- **Model**: gpt-4.1-mini
- **Credentials**: OpenAI API 키 설정
- **Connection**: AI Agent의 Language Model 입력에 연결

#### (2) Simple Memory

**Simple Memory 노드 추가**

- **Session ID Type**: Custom Key
- **Session Key**: scheduled_research_session
- **Connection**: AI Agent의 Memory 입력에 연결
- **기능**: 리서치 세션 컨텍스트 유지

#### (3) Research (Perplexity)

**Research (Perplexity) 노드 추가**

- **Messages**: `={{ $fromAI('message0_Text', '', 'string') }}`
- **Search Recency**: month (최근 1개월)
- **Credentials**: Perplexity API 키 설정
- **Connection**: AI Agent의 Tool 입력에 연결
- **기능**: 심층 웹 검색 및 정보 수집

#### (4) Structured Output Parser

**Structured Output Parser 노드 추가**

**JSON Schema Example**:
```json
{
    "headline": "2025년 상반기 하도급법 전면 개편…원사업자 의무 강화·수급사업자 보호 확대로 거래 관행 대전환",
    "research": "# 최근 공정거래위원회 하도급 정책·규제 브리핑  \n_Last updated: 2025-07-08_\n\n## 요약 한줄\n2025년 상반기, 하도급법 전면 개정과 표준계약서 의무화, 기술자료 보호 강화 등 주요 제도 변화가 시행되면서 원사업자-수급사업자 간 거래 관행이 근본적으로 재편되고 있습니다.\n\n## 정책별 상세 분석\n\n---\n\n- **정책·규제:** 하도급법 개정안 국회 통과 - 서면발급 의무 및 대금지급 기한 단축  \n  • **시행/진행 단계:** 2025년 3월 국회 통과, 6월 시행령 발표, 7월 전면 시행  \n  • **영향 강도:** High  \n  • **규제 방향:** 규제강화  \n  • **영향 대상:** 양측 (원사업자 의무↑, 수급사업자 권리↑)  \n  • **영향 시점:** 즉시  \n  • **근거:** (see #1, #4, #7, #12)  \n  • **요약 설명:** 하도급 계약서 서면발급 의무화(전자문서 포함), 대금지급 기한 60일→45일 단축, 위반 시 과징금 최대 3배 상향으로 원사업자 계약관리 부담 급증, 수급사업자 대금회수 기간 단축.\n\n---\n\n- **정책·규제:** 기술자료 요구 및 유용 금지 강화 - 부당요구 제한 및 처벌 강화  \n  ...(생략)\n\n...",
    "sources": "1. [2025년 하도급법 전면 개정안 국회 통과…대금지급 45일 단축](https://www.ftc.go.kr/www/selectReportUserView.do?key=10&rpttype=1&report_data_no=9876)\n2. [공정위, 기술자료 유용 처벌 강화…형사처벌·3배 배상제 도입](https://www.mk.co.kr/news/economy/10567432)\n..."
}
```

- **Connection**: AI Agent의 Output Parser 입력에 연결

### 4. Airtable 저장

**Create a record 노드 추가**

- **Operation**: Create
- **Base**: appCQ73phYybZqGy8 (Realestate-research)
- **Table**: tblzhDM7a5NxdZwY4 (realestate-research)
- **Columns Mapping**:
  - Headline: `={{ $json.output.headline }}`
  - Research: `={{ $json.output.research }}`
  - Source: `={{ $json.output.sources }}`
- **Credentials**: Airtable Personal Access Token

### 5. 이메일 발송

**Send a message 노드 추가**

- **Send To**: coree2k@gmail.com (받는 사람 이메일)
- **Subject**: `={{ $json.fields.Headline }}`
- **Message**: 
```
={{ $json.fields.Research }}
{{ $json.fields.Source }}
```
- **Credentials**: Gmail OAuth2 계정

### 6. 노드 연결

**연결 구조**:

1. **Schedule Trigger** → **AI Agent**
2. **OpenAI Chat Model** → **AI Agent** (ai_languageModel)
3. **Simple Memory** → **AI Agent** (ai_memory)
4. **Research (Perplexity)** → **AI Agent** (ai_tool)
5. **Structured Output Parser** → **AI Agent** (ai_outputParser)
6. **AI Agent** → **Create a record**
7. **Create a record** → **Send a message**

## 고급 활용 팁

### 1. 리서치 주제 커스터마이징

AI Agent의 Text 필드를 수정하여 다른 주제로 리서치 가능:
- 부동산 정책 리서치
- AI 산업 동향 리서치
- 금융 규제 리서치
- 환경 정책 리서치

### 2. 스케줄 조정

Schedule Trigger의 Interval 변경:
- 주간 리서치: Weeks
- 격주 리서치: Days (14일)
- 분기별 리서치: Months (3개월)

### 3. 다중 리서치 주제

AI Agent를 여러 개 추가하여 동시에 다양한 주제 리서치:
- 공정위 하도급 정책
- 환경부 환경 규제
- 금융위원회 금융 정책

### 4. Slack 알림 추가

이메일 대신 또는 추가로 Slack 알림:
- Slack 노드 추가
- 채널 선택 및 메시지 포맷 설정

### 5. 리서치 품질 향상

System Message 수정으로 리서치 품질 개선:
- 더 많은 소스 요구 (10개 → 20개)
- 특정 출처 우선순위 지정
- 분석 깊이 조정

## 문제 해결

### 자주 발생하는 문제들

#### 1. Perplexity API 호출 실패

**증상**: Research 도구가 작동하지 않음

**해결 방법**:
- Perplexity API 키 확인
- API 할당량 확인
- Search Recency 설정 확인
- 쿼리 형식 점검

#### 2. JSON 파싱 오류

**증상**: Structured Output Parser에서 오류 발생

**해결 방법**:
- JSON Schema Example 확인
- AI Agent의 출력 형식 점검
- System Message의 OUTPUT JSON 섹션 확인

#### 3. Airtable 저장 실패

**증상**: Create a record 노드에서 오류

**해결 방법**:
- Airtable Personal Access Token 확인
- Base ID와 Table ID 확인
- 필드 이름 매칭 확인
- 필드 타입 확인 (Text, Date 등)

#### 4. 이메일 발송 실패

**증상**: Gmail 노드에서 오류

**해결 방법**:
- Gmail OAuth2 권한 확인
- Gmail API 활성화 확인
- 받는 사람 이메일 주소 확인

#### 5. 리서치 결과 품질 문제

**증상**: 부정확하거나 관련 없는 정보

**해결 방법**:
- System Message의 쿼리 패턴 개선
- Search Recency 조정 (month → week)
- 더 구체적인 키워드 추가
- 출처 우선순위 명시

### 디버깅 팁

1. **단계별 테스트**:
   - Schedule Trigger를 수동으로 실행
   - AI Agent의 출력 확인
   - Perplexity 검색 결과 확인

2. **로그 분석**:
   - n8n 실행 로그 확인
   - AI Agent의 사고 과정 확인
   - API 응답 메시지 분석

3. **출력 검증**:
   - JSON 구조 확인
   - Markdown 포맷 확인
   - 소스 링크 유효성 확인

## 실제 사용 예시

### 월간 리서치 자동 실행

```
📅 매월 1일 오전 9시
  ↓
🤖 AI Agent 시작
  - 공정위 하도급 정책 검색 쿼리 생성
  ↓
🔍 Perplexity Deep Search
  - "공정거래위원회 하도급" OR "하도급법" OR ...
  - 최근 1개월 내 자료 10+ 수집
  - 공정위 공식 자료, 법제처, 경제지 등
  ↓
📊 AI 분석 및 구조화
  - 3-5개 주요 정책 식별
  - 영향도, 규제 방향, 시행 시점 분류
  - 실무 체크리스트 생성
  ↓
💾 Airtable 저장
  - Headline, Research, Source 필드 기록
  ↓
📧 Gmail 발송
  - 제목: 2025년 상반기 하도급법 전면 개편…
  - 본문: 상세 분석 리포트 + 출처 링크
```

### 리서치 결과 예시

**Subject**: 2025년 상반기 하도급법 전면 개편…원사업자 의무 강화·수급사업자 보호 확대로 거래 관행 대전환

**Body**:
```
# 최근 공정거래위원회 하도급 정책·규제 브리핑  
_Last updated: 2025-07-08_

## 요약 한줄
2025년 상반기, 하도급법 전면 개정과 표준계약서 의무화, 기술자료 보호 강화 등 주요 제도 변화가 시행되면서 원사업자-수급사업자 간 거래 관행이 근본적으로 재편되고 있습니다.

## 정책별 상세 분석

---

- **정책·규제:** 하도급법 개정안 국회 통과 - 서면발급 의무 및 대금지급 기한 단축  
  • **시행/진행 단계:** 2025년 3월 국회 통과, 6월 시행령 발표, 7월 전면 시행  
  • **영향 강도:** High  
  • **규제 방향:** 규제강화  
  • **영향 대상:** 양측 (원사업자 의무↑, 수급사업자 권리↑)  
  • **영향 시점:** 즉시  
  • **근거:** (see #1, #4, #7, #12)  
  • **요약 설명:** 하도급 계약서 서면발급 의무화(전자문서 포함), 대금지급 기한 60일→45일 단축, 위반 시 과징금 최대 3배 상향으로 원사업자 계약관리 부담 급증, 수급사업자 대금회수 기간 단축.

---

[추가 정책 분석...]

## 실무 체크리스트
- **원사업자 준수사항:**  
  - 하도급 계약서 서면(전자문서 포함) 즉시 발급 (3영업일 이내)  
  - 대금지급 기한 45일 준수 (기존 60일에서 단축)  
  - 표준하도급계약서 사용 의무 (해당 업종)  
  ...

- **수급사업자 권리보호:**  
  - 서면 계약서 미수령 시 공정위 신고 (3영업일 경과 시)  
  - 대금 미지급·지연 시 즉시 이의제기 및 분쟁조정 신청  
  ...

출처:
1. [2025년 하도급법 전면 개정안 국회 통과…대금지급 45일 단축](https://www.ftc.go.kr/...)
2. [공정위, 기술자료 유용 처벌 강화…형사처벌·3배 배상제 도입](https://www.mk.co.kr/...)
...
```

## 확장 아이디어

### 1. 다중 주제 리서치

여러 AI Agent를 병렬로 실행하여 동시에 여러 주제 리서치:
- 공정위 하도급 정책
- 부동산 정책
- 금융 규제
- 환경 정책

### 2. 비교 분석

전월 리서치 결과와 비교하여 변화 추적:
- Airtable에서 이전 기록 조회
- 변경사항 하이라이트
- 트렌드 분석

### 3. 대시보드 연동

리서치 결과를 대시보드로 시각화:
- Notion 페이지 자동 생성
- Google Data Studio 연동
- Power BI 대시보드

### 4. 알림 채널 다양화

다양한 채널로 알림 발송:
- Slack 채널
- Discord 서버
- 카카오톡 메시지
- SMS 알림

### 5. PDF 리포트 생성

리서치 결과를 PDF로 변환:
- HTML to PDF 변환
- 템플릿 기반 리포트 생성
- 자동 배포

## 보안 고려사항

### 1. API 키 관리
- n8n Credentials 기능 활용
- 환경 변수로 키 관리
- 정기적인 키 갱신

### 2. 데이터 접근 제어
- Airtable 공유 권한 설정
- 이메일 수신자 제한
- 민감 정보 필터링

### 3. 리서치 결과 보안
- 내부 전용 정보 마스킹
- 외부 공유 시 승인 절차
- 데이터 보관 기간 설정

### 4. 로그 관리
- 실행 로그 정기 검토
- 오류 알림 설정
- 감사 추적 기능

## 성능 최적화

### 1. API 호출 최적화
- Perplexity API 할당량 관리
- 불필요한 검색 최소화
- 캐싱 활용

### 2. 리서치 품질 향상
- 쿼리 최적화로 정확도 향상
- 소스 다양성 확보
- 출처 신뢰도 검증

### 3. 처리 시간 단축
- 병렬 처리 활용
- 타임아웃 설정 최적화
- 불필요한 노드 제거

## 결론

> 공정위 하도급 정책 자동 리서치 시스템은 매월 변화하는 규제와 정책을 자동으로 추적하고 분석합니다. Perplexity의 Deep Search 기능을 활용하여 공정위 공식 자료를 포함한 다양한 출처에서 정보를 수집하고, AI가 이를 구조화된 리포트로 정리합니다.
>
> 이 시스템은 하도급 거래를 하는 기업의 컴플라이언스 담당자, 법무팀, 경영진에게 유용하며, 최신 정책 동향을 파악하고 실무 대응 방안을 수립하는 데 도움을 줍니다. 매월 자동으로 실행되므로 별도의 수작업 없이 지속적으로 최신 정보를 받아볼 수 있습니다.
> 
> 기본 워크플로우를 바탕으로 리서치 주제를 변경하거나, 여러 주제를 동시에 리서치하거나, 알림 채널을 추가하는 등 다양하게 활용해보세요.

## 참고 자료

- [n8n 공식 문서](https://docs.n8n.io/)
- [OpenAI API 문서](https://platform.openai.com/docs)
- [Perplexity API 문서](https://docs.perplexity.ai/)
- [Airtable API 문서](https://airtable.com/developers/web/api/introduction)
- [Gmail API 문서](https://developers.google.com/gmail/api)
- [공정거래위원회](https://www.ftc.go.kr/)
- [하도급법 관련 정보](https://www.ftc.go.kr/www/selectReportUserList.