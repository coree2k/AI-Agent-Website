### n8n을 활용하여 Slack으로 한국과 미국 기업의 재무제표를 자동으로 분석하고, AI가 생성한 투자 보고서를 받아볼 수 있는 Multi-Agent 시스템 구축 가이드입니다.

## 목차

- [시스템 개요](#시스템-개요)
- [사전 준비사항](#사전-준비사항)
- [n8n 워크플로우 구축](#n8n-워크플로우-구축)
- [전문 AI Agent 설정](#전문-ai-agent-설정)
- [재무 데이터 수집 도구](#재무-데이터-수집-도구)
- [고급 활용 팁](#고급-활용-팁)
- [문제 해결](#문제-해결)
- [한계점](#한계점)

## 시스템 개요

이 가이드에서는 Slack을 통해 한국/미국 기업의 재무제표를 자동으로 분석하여 투자 리포트를 생성하는 시스템을 구축합니다.

### 워크플로우 구조

> 1. **Slack 메시지 수신** → 2. **메시지 유형 분리** → 3. **AI Agent 분석** → 4. **전문 Agent 선택** → 5. **데이터 수집** → 6. **보고서 생성** → 7. **Slack/Gmail 발송**
![워크플로우 구조](./n8n_Source/05-01/2.%20WF.png)


### 주요 기능

- Slack 텍스트/음성 메시지 모두 지원
- 한국/미국 기업 자동 구분 (삼성전자 vs 테슬라)
- 재무제표 3종 자동 수집 (손익계산서, 대차대조표, 현금흐름표)
- GPT-4.1 기반 AI 투자 분석
- Markdown 형식의 투자 보고서 자동 생성
- Slack 채널 + Gmail 동시 발송

### 시스템 통계

- **전체 노드**: 42개
- **AI Agent**: 3개 (메인 라우터 1개 + 전문 Agent 2개)
- **데이터 수집 도구**: 10개 (한국 5개 + 미국 5개)
- **통합 서비스**: 3개 (Slack, Gmail, Markdown)

## 사전 준비사항

- n8n 설치 및 실행 (로컬 또는 클라우드)
- Slack 워크스페이스 및 Bot Token
- OpenAI API 키 (GPT-4.1 또는 GPT-5)
- Tavily API 키 (웹 검색 및 크롤링용)
- Gmail 계정 (선택사항)

## n8n 워크플로우 구축

### 1. Slack Trigger 설정

1. **Slack Trigger 노드 추가**
2. **기본 설정**:
   - Trigger 타입: `app_mention`, `message`
   - Channel ID: 분석 채널 선택
   - Credentials: Slack OAuth2 API 연동

**필요한 Slack Bot Scopes**:
- `chat:write`
- `channels:history`
- `files:read`

### 2. Switch 노드로 메시지 유형 분리

1. **Switch 노드 추가**
2. **조건 설정**:

**Route 1 - 음성 메시지**:
```
조건: {{ $json.subtype }} exists
→ Slack 파일 다운로드 → 음성 텍스트 변환
```

**Route 2 - 텍스트 메시지**:
```
조건: {{ $json.blocks[0].elements[0].elements[0].type }} equals "text"
→ 바로 AI Agent로 전달
```

### 3. 음성 메시지 처리 (선택사항)

음성 메시지를 지원하려면 다음 노드들을 추가합니다:

1. **Wait 노드**: 10초 대기 (Slack 음성 처리 시간)
2. **Get a file 노드**: Slack 파일 다운로드
3. **If 노드**: transcription 상태 확인
4. **Edit Fields 노드**: 텍스트 추출

```
input: {{ $json.transcription.preview.content }}
```

### 4. Edit Fields 노드

1. **Edit Fields 노드 추가**
2. **필드 설정**:
   - Name: `input`
   - Value: `{{ $json.text }}`

### 5. AI Agent (메인 라우터)

1. **AI Agent 노드 추가**
2. **모델**: OpenAI GPT-5
3. **메모리**: Simple Memory (Buffer Window)
   - Session Key: `{{ $('Slack Trigger1').item.json.channel }}`
   - Context Window Length: 10

**System Prompt (핵심 부분)**:
```
# 핵심 임무
당신은 글로벌 주식시장 전문 금융 애널리스트이자 자동화된 투자 리서치 시스템입니다.

사용자 질문을 분석하여:
1. 기업의 국가/시장을 자동 식별 (한국 vs 미국)
2. 적절한 전문 Agent Tool 선택 (KR AI Tool vs USA AI Tool)
3. 해당 Agent에게 분석 요청을 위임

## 시장 식별 로직

### 한국 시장 (KR AI Tool 사용)
- 6자리 숫자 티커: 005930, 000660 등
- 한국 기업명: 삼성전자, SK하이닉스, 네이버, 카카오 등
- .KS 또는 .KQ 접미사
- "한국 기업", "코스피", "코스닥" 명시

### 미국 시장 (USA AI Tool 사용)
- 영문자 티커 (1~5자): TSLA, AAPL, NVDA 등
- 미국 기업명: 테슬라, 애플, 구글, 메타 등
- "미국 기업", "나스닥", "NYSE" 명시

## 도구 사용
- 한국 기업 → KR AI Tool 호출
- 미국 기업 → USA AI Tool 호출
- 비교 분석 → 두 Agent 모두 호출
```

**User Prompt**:
```
{{ $json.input }} {{ $('Slack Trigger1').item.json.channel }}
```

### 6. Slack 메시지 전송

1. **Send a message 노드 추가**
2. **기본 설정**:
   - Authentication: OAuth2
   - Select: channel
   - Channel ID: 전송할 채널 선택
   - Text: `{{ $json.output.text }}`
   - Options: `includeLinkToWorkflow` OFF

### 7. Gmail 전송 (선택사항)

1. **Gmail 노드 추가**
2. **기본 설정**:
   - Send To: 수신 이메일
   - Subject: `{{ $('AI Agent').item.json.output.subject }}`
   - Message: `{{ $json.message.text }}`

## 전문 AI Agent 설정

### KR AI Tool (한국 기업 전문 Agent)

1. **Agent Tool 노드 추가**
2. **기본 설정**:
   - Name: `KR AI Tool`
   - Model: OpenAI GPT-4.1-mini
   - Memory: Simple Memory (Buffer Window)

**System Prompt (핵심 부분)**:
```
# 한국 주식 분석 AI Agent

당신은 한국 주식시장 전문 금융 애널리스트입니다.

## 사용 가능한 도구
1. KR Search: 한국 기업 뉴스 검색
2. KR Get Price: 주가 히스토리 (Yahoo Finance .KS)
3. KR Get Income Statement: 손익계산서
4. KR Get Balance Sheet: 대차대조표
5. KR Get Cash Flow: 현금흐름표

## 출력 형식 (JSON)
{
  "ticker": "005930",
  "subject": "삼성전자(005930) 2025년 3분기 실적 분석",
  "text": "# 삼성전자(005930) 투자 분석\n\n## 📈 핵심 요약\n..."
}

## 중요 규칙
- 한국어 용어 사용: 매출액, 영업이익, 당기순이익
- 금액 단위: 조원, 억원
- Markdown 표(table) 사용 금지 → 불릿 리스트 사용
- 분량: 1,500~2,500자
```

**도구 연결**:
- KR Search
- KR Get Price
- KR Get Income Statement
- KR Get Balance Sheet
- KR Get Cash Flow

### USA AI Tool (미국 기업 전문 Agent)

1. **Agent Tool 노드 추가**
2. **기본 설정**:
   - Name: `USA AI Tool`
   - Model: OpenAI GPT-4.1-mini
   - Memory: Simple Memory (Buffer Window)

**System Prompt (핵심 부분)**:
```
# 미국 주식 분석 AI Agent

당신은 미국 주식시장 전문 금융 애널리스트입니다.

## 사용 가능한 도구
1. Search: 인터넷 뉴스 검색 (Tavily)
2. Get Price: 주가 히스토리 (Yahoo Finance)
3. Get Income Statement: 손익계산서
4. Get Balance Sheet: 대차대조표
5. Get Cash Flow: 현금흐름표

## 출력 형식 (JSON)
{
  "ticker": "TSLA",
  "subject": "테슬라(TSLA) 2025년 10월 투자 분석",
  "text": "# 테슬라(TSLA) 투자 분석\n\n## 📈 핵심 요약\n..."
}

## 중요 규칙
- 한국어로 작성 (영문 소스 → 한국어 번역)
- 금액 단위: 달러 ($B, $M)
- Markdown 표(table) 사용 금지 → 불릿 리스트 사용
- 분량: 1,000~2,000자
```

**도구 연결**:
- Search
- Get Price
- Get Income Statement
- Get Balance Sheet
- Get Cash Flow

## 재무 데이터 수집 도구

모든 도구는 **HTTP Request Tool** 노드를 사용하며, Tavily API로 Yahoo Finance를 크롤링합니다.

### 1. Search (뉴스/리서치 검색)

**기본 설정**:
- Tool Description: "인터넷을 활용해 특정 회사에 대한 추가 리서치가 필요할 때 사용"
- Method: POST
- URL: `https://api.tavily.com/search`
- Authentication: HTTP Header Auth (Tavily API Key)

**Headers**:
```
Content-Type: application/json
```

**Body (JSON)**:
```json
{
  "query": "{{ $fromAI('query','search term') }}",
  "topic": "{{ $fromAI('topic','general or news') }}",
  "search_depth": "advanced",
  "max_results": 1,
  "days": 7
}
```

### 2. Get Price (주가 히스토리)

**기본 설정**:
- Tool Description: "특정 회사의 주가 데이터가 필요할 때 Yahoo Finance에서 수집"
- Method: POST
- URL: `https://api.tavily.com/extract`

**Body (JSON)**:
```json
{
  "urls": "{{ $fromAI('url','https://finance.yahoo.com/quote/{ticker}/history/') }}",
  "include_images": false,
  "extract_depth": "basic"
}
```

**한국 기업용 (KR Get Price)**:
```
URL: https://finance.yahoo.com/quote/{ticker}.KS/history/
```

### 3. Get Income Statement (손익계산서)

**Body (JSON)**:
```json
{
  "urls": "{{ $fromAI('url','https://finance.yahoo.com/quote/{ticker}/financials/') }}",
  "include_images": false,
  "extract_depth": "basic"
}
```

**한국 기업용**:
```
URL: https://finance.yahoo.com/quote/{ticker}.KS/financials/
```

### 4. Get Balance Sheet (대차대조표)

**Body (JSON)**:
```json
{
  "urls": "{{ $fromAI('url','https://finance.yahoo.com/quote/{ticker}/balance-sheet/') }}",
  "include_images": false,
  "extract_depth": "basic"
}
```

**한국 기업용**:
```
URL: https://finance.yahoo.com/quote/{ticker}.KS/balance-sheet/
```

### 5. Get Cash Flow (현금흐름표)

**Body (JSON)**:
```json
{
  "urls": "{{ $fromAI('url','https://finance.yahoo.com/quote/{ticker}/cash-flow/') }}",
  "include_images": false,
  "extract_depth": "basic"
}
```

**한국 기업용**:
```
URL: https://finance.yahoo.com/quote/{ticker}.KS/cash-flow/
```

## 고급 활용 팁

### 출력 형식 최적화

**Structured Output Parser 사용**:
```json
{
  "ticker": "NFLX",
  "subject": "넷플릭스 광고 매출 분기별 성장세 분석 - 2025년 5월",
  "text": "# 넷플릭스 광고 매출 분기별 성장세(2023~2025)\n\n..."
}
```

이 파서를 각 Agent Tool에 연결하여 일관된 출력 형식을 보장합니다.

### Markdown 포맷 가이드

**Slack에서 표가 지원되지 않으므로 불릿 리스트 사용**:

```markdown
## 💰 재무 성과

**매출액**
• 2025년 3Q: 79.1조원
• 2024년 3Q: 67.4조원
• YoY 성장률: +17.4%

**영업이익**
• 2025년 3Q: 13.8조원
• 2024년 3Q: 2.8조원
• YoY 성장률: +392.9%
```

### 비교 분석

두 Agent를 동시에 호출하여 비교 분석:

```
사용자: "삼성전자와 애플 비교 분석해줘"

→ KR AI Tool: 삼성전자 분석
→ USA AI Tool: 애플 분석
→ 메인 Agent: 두 결과 통합하여 비교 보고서 생성
```

## 문제 해결

### 자주 발생하는 문제들

1. **Slack OAuth 인증 실패**:
   - Bot Token Scopes 확인: `chat:write`, `channels:history`, `files:read`
   - 앱이 채널에 추가되었는지 확인
   - Redirect URI 확인

2. **티커 심볼 인식 실패**:
   - 한국 기업: 종목코드 6자리 (005930) 또는 기업명
   - 미국 기업: 영문 티커 (TSLA) 또는 영문 기업명
   - 애매한 경우 "한국" 또는 "미국" 명시

3. **Yahoo Finance 크롤링 실패**:
   - Tavily API 키 확인
   - API 사용량 제한 확인
   - URL 형식 확인 (.KS는 한국, 없으면 미국)

4. **음성 메시지 처리 실패**:
   - Wait 노드에서 10초 대기 후 재시도
   - Slack 파일 권한 확인
   - `transcription.status`가 "complete"인지 확인

5. **메시지 전송 오류**:
   - Slack 채널 권한 확인
   - JSON 형식 오류 확인 (특수문자 이스케이프)
   - 메시지 길이 제한 확인

## 한계점

### 현재 한계점

1. **데이터 정확성**:
   - Yahoo Finance 크롤링 결과가 항상 정확하지 않을 수 있음
   - 실시간 데이터가 아닌 지연된 데이터

2. **비용**:
   - OpenAI GPT-4.1/5 사용으로 API 비용 발생
   - Tavily API 사용량 제한

3. **처리 시간**:
   - 복잡한 분석 시 1~2분 소요
   - 여러 도구를 사용하면 시간 증가

4. **Slack 제약**:
   - Markdown 표가 제대로 렌더링되지 않음
   - 메시지 길이 제한

5. **개인 메시지 한정**:
   - 현재 설정은 특정 채널에만 전송
   - DM이나 다른 채널로 자동 전송 불가

### 개선 방향

1. **실시간 데이터 통합**:
   - SEC EDGAR API 직접 연동
   - 금융감독원 DART API 연동
   - 실시간 주가 데이터 제공

2. **차트 생성 기능**:
   - 주가 차트 자동 생성
   - 재무 데이터 시각화
   - Chart.js 또는 Plotly 활용

3. **포트폴리오 관리**:
   - 보유 종목 자동 추적
   - 알림 시스템 구축
   - 수익률 계산

4. **비교 분석 강화**:
   - 동종업계 자동 비교
   - 벤치마크 분석
   - 멀티플 비교

## 사용 예시

### 예시 1: 한국 기업 분석

**입력 (Slack)**:
```
삼성전자 최근 실적 어때?
```

**처리 과정**:
1. AI Agent가 "삼성전자" 인식 → 한국 기업
2. KR AI Tool 호출
3. 종목코드 005930 추출
4. Yahoo Finance .KS에서 데이터 수집
5. 투자 보고서 생성 (한국어, 조원 단위)
6. Slack + Gmail 발송

**출력 예시**:
```markdown
# 삼성전자(005930) 투자 분석

## 📈 핵심 요약
- **현재 주가**: 75,200원 (+2.3%)
- **시가총액**: 448조원
- **투자 의견**: 적극 매수

## 💰 재무 성과

**매출액**
• 2025년 3Q: 79.1조원
• YoY 성장률: +17.4%

**영업이익**
• 2025년 3Q: 13.8조원
• YoY 성장률: +392.9%
...
```

### 예시 2: 미국 기업 분석

**입력 (Slack)**:
```
테슬라 급등 이유는?
```

**처리 과정**:
1. AI Agent가 "테슬라" 인식 → 미국 기업
2. USA AI Tool 호출
3. 티커 TSLA 추출
4. Tavily로 뉴스 검색 + Yahoo Finance 데이터 수집
5. 투자 보고서 생성 (한국어, 달러 단위)
6. Slack + Gmail 발송

### 예시 3: 비교 분석

**입력 (Slack)**:
```
삼성전자와 애플 비교 분석해줘
```

**처리 과정**:
1. AI Agent가 두 기업 인식 → 한국 + 미국
2. KR AI Tool + USA AI Tool 동시 호출
3. 각각 데이터 수집 및 분석
4. 메인 Agent가 두 결과를 통합하여 비교 보고서 생성

## 기술 세부사항

### 사용된 n8n 노드

| 노드 타입 | 버전 | 용도 |
|---------|------|------|
| Slack Trigger | v1 | 메시지 수신 |
| Switch | v3.2 | 메시지 유형 분리 |
| AI Agent | v2.2 | 메인 라우터 |
| Agent Tool | v2.2 | 전문 Agent |
| HTTP Request Tool | v4.2 | 데이터 수집 |
| OpenAI Chat Model | v1.2 | LLM |
| Memory Buffer Window | v1.3 | 대화 기억 |
| Edit Fields | v3.4 | 데이터 가공 |
| Gmail | v2.1 | 이메일 발송 |

### 외부 API

- **OpenAI**: GPT-4.1-mini, GPT-5
- **Tavily**: Search & Extract API
- **Yahoo Finance**: 재무 데이터 크롤링 (Tavily를 통해)
- **Slack**: Bot API, OAuth2
- **Gmail**: SMTP API

### 메모리 관리

각 Agent는 **Simple Memory (Buffer Window)**를 사용하여 대화 컨텍스트를 유지합니다:

- Session Key: Slack 채널 ID
- Context Window Length: 최근 10개 메시지
- 채널별 독립적인 세션 관리

## 결론

이 Multi-Agent 시스템은 n8n의 유연성과 AI Agent의 자율성을 결합하여, 복잡한 금융 분석 작업을 자동화합니다.

**핵심 장점**:
- 🌍 글로벌 커버리지: 한국과 미국 시장 동시 지원
- 🤖 완전 자동화: 티커 식별부터 보고서 작성까지
- 📊 종합 분석: 재무제표 + 뉴스 + 주가 통합
- 💬 편리한 인터페이스: Slack으로 간편하게 질문

**다음 단계**:
이 워크플로우를 기반으로 포트폴리오 추적, 자동 알림, 산업 분석 등의 기능을 추가할 수 있습니다.

## 참고 자료

- [n8n 공식 문서](https://docs.n8n.io/)
- [OpenAI API 문서](https://platform.openai.com/docs)
- [Tavily API 문서](https://docs.tavily.com/)
- [Yahoo Finance](https://finance.yahoo.com/)
- [Slack API 문서](https://api.slack.com/)

---

📄 **JSON 워크플로우 파일**: `51.json`  
📊 **전체 노드 수**: 42개  
🤖 **AI Agent**: 3개  
🔧 **데이터 수집 도구**: 10개