### n8n을 활용하여 Slack으로 한국 기업의 재무제표를 자동으로 분석하고, AI가 생성한 투자 보고서를 받아볼 수 있는 시스템 구축 가이드입니다.

## 목차

- [시스템 개요](#시스템-개요)
- [사전 준비사항](#사전-준비사항)
- [Slack 설정](#slack-설정)
- [n8n 워크플로우 구축](#n8n-워크플로우-구축)
- [AI Agent 설정](#ai-agent-설정)
- [재무 데이터 수집 도구](#재무-데이터-수집-도구)
- [고급 활용 팁](#고급-활용-팁)
- [문제 해결](#문제-해결)
- [한계점 및 개선 방향](#한계점-및-개선-방향)

## 시스템 개요

이 가이드에서는 Slack을 통해 **한국 상장 기업의 재무제표를 자동으로 분석**하여 투자 리포트를 생성하는 시스템을 구축합니다.

### 워크플로우 구조

>1. **Slack 메시지 수신** (텍스트/음성) → 2. **메시지 유형 분리** → 3. **AI Agent 분석** → 4. **재무 데이터 수집** → 5. **보고서 생성** → 6. **Slack/Gmail 발송**

![워크플로우 구조](./n8n_Source/05-03/2.%20WF.png)

### 주요 기능

- Slack 텍스트 메시지 및 음성 메시지 모두 지원
- 한국 코스피/코스닥 상장 기업 자동 분석 (종목코드 기반)
- Yahoo Finance에서 재무제표 3종 자동 수집
  - 손익계산서 (Income Statement)
  - 대차대조표 (Balance Sheet)
  - 현금흐름표 (Cash Flow)
- GPT-5 기반 AI 투자 분석
- 한국어 Markdown 형식의 투자 보고서 자동 생성
- Slack 채널 + Gmail 동시 발송

### 시스템 통계

- **전체 노드**: 28개
- **AI Agent**: 2개 (메인 Agent + KR AI Tool)
- **데이터 수집 도구**: 5개
- **통합 서비스**: 2개 (Slack, Gmail)

## 사전 준비사항

- n8n 설치 및 실행
- Slack 워크스페이스 및 Bot 설정
- OpenAI API 키 (GPT-5, GPT-4.1-mini)
- Tavily API 키 (웹 검색 및 Yahoo Finance 크롤링용)
- Gmail 계정 (선택사항)

## Slack 설정

### 1. Slack App 생성

1. [Slack API](https://api.slack.com/apps)에 접속하여 "Create New App" 클릭
2. "From scratch" 선택
3. App 이름과 워크스페이스 선택

### 2. Bot Token Scopes 설정

**OAuth & Permissions** 메뉴에서 다음 권한 추가:

- `app_mentions:read` - 멘션 읽기
- `chat:write` - 메시지 전송
- `channels:history` - 채널 메시지 읽기
- `files:read` - 파일 읽기 (음성 메시지용)

### 3. Event Subscriptions 활성화

1. **Event Subscriptions** 메뉴 활성화
2. **Subscribe to bot events** 추가:
   - `app_mention`
   - `message.channels`

### 4. 채널에 Bot 추가

분석을 받을 Slack 채널에 Bot을 초대합니다:
```
/invite @YourBotName
```

## n8n 워크플로우 구축

### 1. Slack Trigger 설정

1. **Slack Trigger 노드 추가**
2. **기본 설정**:
   - Trigger: `app_mention`, `message`
   - Channel ID: `n8n-테스트` (분석 채널)
   - Credentials: Slack API 연동

### 2. Switch 노드로 메시지 유형 분리

1. **Switch 노드 추가**
2. **조건 설정**:

**Route 1 - 음성 메시지**:
```
조건: {{ $json.subtype }} exists
→ Wait → Get a file → If (transcription 확인) → Edit Fields1
```

**Route 2 - 텍스트 메시지**:
```
조건: {{ $json.blocks[0].elements[0].elements[0].type }} equals "text"
→ Edit Fields → AI Agent
```

### 3. 음성 메시지 처리 플로우

음성 메시지를 지원하려면:

**3-1. Wait 노드**
- Amount: 10초
- Slack의 음성 → 텍스트 변환 대기

**3-2. Get a file 노드**
```
Resource: file
Operation: get
File ID: {{ $json.files[0].id }}
Authentication: OAuth2
```

**3-3. If 노드**
```
조건: {{ $json.transcription.status }} equals "processing"
True → Wait (재시도)
False → Edit Fields1 (텍스트 추출)
```

**3-4. Edit Fields1 노드**
```
Name: input
Value: {{ $json.transcription.preview.content }}
```

### 4. 텍스트 메시지 처리

**Edit Fields 노드**:
```
Name: input
Value: {{ $json.text }}
```

### 5. AI Agent 설정 (메인)

1. **AI Agent 노드 추가**
2. **기본 설정**:
   - Type: Agent
   - Prompt Type: Define
   - Text: `{{ $json.input }} {{ $('Slack Trigger1').item.json.channel }}`

**연결된 컴포넌트**:
- Language Model: OpenAI Chat Model (GPT-5)
- Memory: Simple Memory (Buffer Window)
- Tools: KR AI Tool (한국 기업 전문 Sub-Agent)

**System Prompt** (핵심 부분):
```
# 한국 주식 분석 AI Agent

당신은 한국 주식시장 전문 금융 애널리스트입니다.

## 핵심 임무
1. 종목 코드를 정확히 식별 (삼성전자 → 005930)
2. 필요한 도구만 선별적으로 호출 (1~3개)
3. 전략적 통찰이 담긴 투자 보고서를 Markdown 형식으로 작성

## 출력 형식 (JSON)
{
  "ticker": "005930",
  "subject": "삼성전자(005930) 2025년 3분기 실적 분석",
  "text": "# 삼성전자(005930) 투자 분석\n\n..."
}

## 중요 규칙
- 한국어 용어 사용: 매출액, 영업이익, 당기순이익
- 금액 단위: 조원, 억원
- Markdown 표(table) 사용 금지 → 불릿 리스트 사용
- 분량: 1,500~2,500자
```

### 6. KR AI Tool 설정 (Sub-Agent)

**Agent Tool 노드**:
```
Name: KR AI Tool
Type: Agent Tool
Model: GPT-4.1-mini
Memory: Simple Memory (Buffer Window)
```

**System Prompt** (간소화 버전):
```
당신은 전문 금융 애널리스트입니다.
오늘 날짜는 {{ $today.format('yyyy-MM-dd') }}입니다.

## 사용 가능한 도구:
1. Get Price - 주가 데이터
2. Get Income Statement - 손익계산서
3. Get Balance Sheet - 대차대조표
4. Get Cash Flow - 현금흐름표
5. Search - 인터넷 검색

## 출력 형식:
{
  "ticker": "005930",
  "subject": "제목",
  "text": "[Markdown 보고서]"
}
```

**연결된 도구**:
- KR Search
- KR Get Price
- KR Get Income Statement
- KR Get Balance Sheet
- KR Get Cash Flow

### 7. Language Model 설정

**메인 Agent**:
```
Model: gpt-5
Temperature: 기본값
```

**KR AI Tool**:
```
Model: gpt-4.1-mini
Temperature: 기본값
```

### 8. Memory 설정

**Simple Memory 노드** (메인 Agent):
```
Session ID Type: Custom Key
Session Key: {{ $('Slack Trigger1').item.json.channel }}
Context Window Length: 10
```

**Simple Memory2 노드** (KR AI Tool):
```
Session ID Type: Custom Key
Session Key: {{ $('Slack Trigger1').item.json.channel }}
Context Window Length: 10
```

### 9. Output Parser 설정

**Structured Output Parser1 노드**:
```json
{
  "ticker": "005930",
  "subject": "삼성전자 실적 분석",
  "text": "# 삼성전자(005930) 투자 분석\n\n..."
}
```

### 10. Slack 메시지 전송

**Send a message 노드**:
```
Authentication: OAuth2
Select: channel
Channel ID: n8n-테스트
Text: {{ $json.output.text }}
Options: includeLinkToWorkflow = false
```

### 11. Gmail 전송 (선택사항)

**Gmail 노드**:
```
Send To: coree2k.biz@gmail.com
Subject: {{ $('AI Agent').item.json.output.subject }}
Message: {{ $json.message.text }}
Options: appendAttribution = false
```

## 재무 데이터 수집 도구

모든 도구는 **HTTP Request Tool** 노드를 사용하며, Tavily API로 Yahoo Finance를 크롤링합니다.

### 공통 설정

- **Authentication**: HTTP Header Auth
- **Header**: `Content-Type: application/json`
- **Tavily API Key**: Header Auth Credentials

### 1. KR Search (뉴스/리서치 검색)

**기본 설정**:
```
Tool Description: 한국의 특정 회사에 대한 추가 리서치가 필요할 때 사용
Method: POST
URL: https://api.tavily.com/search
```

**Body (JSON)**:
```json
{
  "query": "{{ $fromAI('query','search term') }}",
  "topic": "{{ $fromAI('topic','general or news') }}",
  "search_depth": "advanced",
  "chunks_per_source": 3,
  "max_results": 1,
  "days": 7,
  "include_answer": false,
  "include_raw_content": false,
  "include_images": true
}
```

**사용 예시**:
```
질문: "삼성전자 HBM 뉴스"
→ query: "삼성전자 HBM"
→ topic: "news"
```

### 2. KR Get Price (주가 히스토리)

**기본 설정**:
```
Tool Description: 한국 회사의 주가 데이터가 필요할 때 수집
Method: POST
URL: https://api.tavily.com/extract
```

**Body (JSON)**:
```json
{
  "urls": "{{ $fromAI('url','https://finance.yahoo.com/quote/{ticker}.KS/history/') }}",
  "include_images": false,
  "extract_depth": "basic"
}
```

**사용 예시**:
```
질문: "삼성전자 주가 흐름은?"
→ url: "https://finance.yahoo.com/quote/005930.KS/history/"
```

**중요**: 한국 종목은 `.KS` (코스피) 또는 `.KQ` (코스닥) 접미사 필요

### 3. KR Get Income Statement (손익계산서)

**Body (JSON)**:
```json
{
  "urls": "{{ $fromAI('url','https://finance.yahoo.com/quote/{ticker}.KS/financials/') }}",
  "include_images": false,
  "extract_depth": "basic"
}
```

### 4. KR Get Balance Sheet (대차대조표)

**Body (JSON)**:
```json
{
  "urls": "{{ $fromAI('url','https://finance.yahoo.com/quote/{ticker}.KS/balance-sheet/') }}",
  "include_images": false,
  "extract_depth": "basic"
}
```

### 5. KR Get Cash Flow (현금흐름표)

**Body (JSON)**:
```json
{
  "urls": "{{ $fromAI('url','https://finance.yahoo.com/quote/{ticker}.KS/cash-flow/') }}",
  "include_images": false,
  "extract_depth": "basic"
}
```

## 고급 활용 팁

### 한국식 Markdown 포맷

Slack에서 표가 지원되지 않으므로 불릿 리스트 사용:

```markdown
## 💰 재무 성과 (최근 4분기)

**매출액**
• 2025년 3Q: 79.1조원
• 2024년 3Q: 67.4조원
• YoY 성장률: +17.4%

**영업이익**
• 2025년 3Q: 13.8조원
• 2024년 3Q: 2.8조원
• YoY 성장률: +392.9%

**당기순이익**
• 2025년 3Q: 10.2조원
• 2024년 3Q: 2.1조원
• YoY 성장률: +385.7%
```

### 한국 보고서 구조

```markdown
# [기업명(종목코드)] 투자 분석

## 📈 핵심 요약
- 현재 주가
- 시가총액
- 투자 의견

## 💰 재무 성과
- 매출액
- 영업이익
- 당기순이익

## 🔍 투자 포인트
### ✅ 강점
1. ...
2. ...

### ⚠️ 리스크
1. ...
2. ...

## 📊 밸류에이션
- PER (주가수익비율)
- PBR (주가순자산비율)
- 배당수익률
- 목표주가

## 🎯 결론
종합 평가 및 투자 의견

> 💡 **한줄 요약**: 핵심 투자 포인트
```

### 한국 시장 특성 반영

보고서에 다음 요소 포함:

1. **재벌 구조**: 계열사 관계, 오너십
2. **수급 분석**: 외국인, 기관, 개인 보유 비율
3. **정부 정책**: 규제, 지원책
4. **환율 영향**: 수출 기업의 환율 민감도
5. **산업 트렌드**: 업종별 특성

### 도구 선택 전략

**질문 유형별 도구 조합**:

1. **실적 분석**: Get Income Statement + Get Price
2. **급등/급락 이유**: Search + Get Price
3. **재무 안정성**: Get Balance Sheet + Get Cash Flow
4. **종합 분석**: 3~4개 도구 조합
5. **주가만 확인**: Get Price만

## 문제 해결

### 자주 발생하는 문제들

**1. Slack OAuth 인증 실패**
- Bot Token Scopes 확인
- 앱이 채널에 추가되었는지 확인
- Redirect URI 설정 확인

**2. 종목 코드 인식 실패**
```
입력: "삼성전자 분석해줘"
→ AI가 005930으로 변환

입력: "TSLA 분석해줘"
→ 미국 종목이므로 오류 (또는 51.json Multi-Agent 사용)

해결: 한국 기업명 또는 6자리 종목코드 사용
```

**3. Yahoo Finance 크롤링 실패**
- Tavily API 키 확인
- API 사용량 제한 확인
- 종목코드 + `.KS` 또는 `.KQ` 확인

**4. 음성 메시지 처리 실패**
- Wait 노드 10초 대기 확인
- Slack 파일 권한 확인 (`files:read`)
- transcription.status가 "complete"인지 확인

**5. 메시지 전송 오류**
```
오류: "channel_not_found"
→ 채널 ID 확인, Bot이 채널에 초대되었는지 확인

오류: "invalid_auth"
→ Slack OAuth Token 재발급

오류: JSON parsing error
→ 특수문자 이스케이프 확인
```

**6. 빈 응답 또는 불완전한 데이터**
- Yahoo Finance .KS/.KQ 데이터 존재 여부 확인
- 네이버 금융(https://finance.naver.com)에서 확인
- FnGuide(https://comp.fnguide.com)에서 확인

### 디버깅 팁

1. **n8n 실행 로그 확인**: 각 노드의 입출력 데이터 검토
2. **종목코드 확인**: 6자리 숫자 + .KS/.KQ
3. **Yahoo Finance 직접 접속**: 브라우저로 URL 확인
4. **네이버 금융 대체**: Yahoo Finance 실패 시 대안

## 한계점 및 개선 방향

### 현재 한계점

1. **한국 기업만 지원**
   - 미국 기업(.US) 분석 불가
   - 다른 국가 시장 미지원

2. **데이터 정확성**
   - Yahoo Finance 한국 데이터의 정확성 문제
   - 네이버 금융, FnGuide 데이터가 더 정확
   - 페이지 구조 변경 시 크롤링 실패

3. **비용**
   - OpenAI GPT-5: API 호출당 비용
   - OpenAI GPT-4.1-mini: Sub-Agent 비용
   - Tavily API: 월간 사용량 제한

4. **처리 시간**
   - 복잡한 분석 시 1~2분 소요
   - 여러 도구 사용 시 시간 증가
   - Sub-Agent 구조로 인한 지연

5. **Slack 제약**
   - Markdown 표 미지원
   - 메시지 길이 제한 (4,000자)
   - 이미지/차트 생성 불가

6. **한국 시장 데이터 한계**
   - 공매도 정보 없음
   - 실시간 호가 없음
   - DART 공시 미연동

### 개선 방향

1. **네이버 금융 API 연동**
   - Yahoo Finance 대체
   - 더 정확한 한국 데이터
   - 실시간 주가 정보

2. **DART API 연동**
   - 금융감독원 공시 자동 수집
   - 실적 발표 자동 분석
   - 사업보고서 크롤링

3. **차트 생성**
   - Chart.js 또는 Plotly 활용
   - 주가 차트 자동 생성
   - 재무 데이터 시각화

4. **포트폴리오 관리**
   - 보유 종목 추적
   - 수익률 계산
   - 알림 시스템

5. **외국인/기관 수급 분석**
   - 일일 순매수/순매도
   - 보유 비율 추이
   - 수급 패턴 분석

6. **다중 시장 지원**
   - 미국 시장 추가 → Multi-Agent (51.json)
   - 일본, 중국 시장 확장

## 사용 예시

### 예시 1: 기본 실적 분석

**입력 (Slack)**:
```
삼성전자 최근 실적 어때?
```

**처리 과정**:
1. 메인 AI Agent가 "삼성전자" 인식
2. KR AI Tool에게 분석 위임
3. KR AI Tool이 005930 추출
4. Get Income Statement + Get Price 호출
5. 데이터 분석 및 보고서 생성
6. Slack + Gmail 발송

**출력 예시**:
```markdown
# 삼성전자(005930) 2025년 3분기 실적 분석

## 📈 핵심 요약
- **현재 주가**: 75,200원 (+2.3%)
- **시가총액**: 448조원
- **투자 의견**: 적극 매수

## 💰 재무 성과

**매출액**
• 2025년 3Q: 79.1조원
• YoY 성장률: +17.4%

**영업이익**
• 2025년 3Q: 13.8조원
• YoY 성장률: +392.9%

**당기순이익**
• 2025년 3Q: 10.2조원
• YoY 성장률: +385.7%

## 🔍 투자 포인트

### ✅ 강점
1. **HBM 양산 본격화**: HBM3E 양산으로 고마진 구조 전환
2. **파운드리 턴어라운드**: 3nm 수율 개선으로 흑자 전환 기대
3. **주주환원 정책**: 배당성향 50% 이상 확대

### ⚠️ 리스크
1. **SK하이닉스 경쟁**: HBM 점유율 격차
2. **중국 의존도**: 매출의 32% 중국 시장

## 📊 밸류에이션
- **PER**: 12.5배 (업종 평균 15.2배 대비 저평가)
- **PBR**: 1.2배
- **배당수익률**: 2.8%
- **목표주가**: 95,000원 (+26.3%)

## 🎯 결론

삼성전자는 HBM 본격 양산과 파운드리 실적 개선으로 
반도체 업황 회복의 최대 수혜주. 
현재 밸류에이션은 업종 대비 저평가 구간.

> 💡 **한줄 요약**: HBM 슈퍼사이클 + 파운드리 턴어라운드 = 적극 매수

---
*본 보고서는 2025-10-11 기준으로 작성되었습니다.*
```

### 예시 2: 급등 이유 분석

**입력 (Slack)**:
```
SK하이닉스 급등 이유는?
```

**처리 과정**:
1. 메인 AI Agent가 "SK하이닉스" 인식
2. KR AI Tool이 000660 추출
3. Search + Get Price 호출
4. 뉴스 + 주가 데이터 통합 분석

**출력 예시**:
```markdown
# SK하이닉스(000660) 급등 분석 - 2025년 10월

## 📈 주가 동향
- **현재 주가**: 168,500원 (+8.7%)
- **52주 최고가**: 178,000원
- **거래량**: 전일 대비 2.8배 급증

## 📰 급등 이유

### HBM3E 대규모 공급 계약 체결
• 엔비디아와 2026년 상반기 HBM3E 공급 계약 (추정 10조원 규모)
• SK하이닉스 HBM 시장 점유율 50% 돌파
• 차세대 HBM4 양산 일정 앞당김 (2026년 하반기)

### 경쟁사 대비 우위
• 삼성전자 대비 6개월 선행
• 마이진: 영업이익률 35% 예상 (전년 대비 +15%p)

## 🎯 전망
단기 과열 우려 있으나, AI 칩 수요 지속으로 
중장기 성장 스토리 유효. 목표주가 200,000원 유지.
```

### 예시 3: 음성 메시지

**입력 (Slack 음성)**:
```
🎤 "카카오 재무 구조 어때?"
```

**처리 과정**:
1. Slack 음성 → 텍스트 자동 변환
2. "카카오 재무 구조 어때?" 텍스트 추출
3. KR AI Tool이 035720 추출
4. Get Balance Sheet + Get Cash Flow 호출
5. 재무 안정성 분석

## 기술 세부사항

### 사용된 n8n 노드

| 노드 타입 | 버전 | 개수 | 용도 |
|---------|------|-----|------|
| Slack Trigger | v1 | 1 | 메시지 수신 |
| Switch | v3.2 | 1 | 메시지 유형 분리 |
| Wait | v1.1 | 1 | 음성 처리 대기 |
| If | v2.2 | 1 | transcription 확인 |
| Edit Fields | v3.4 | 2 | 데이터 가공 |
| AI Agent | v2.2 | 1 | 메인 Agent |
| Agent Tool | v2.2 | 1 | KR AI Tool (Sub-Agent) |
| HTTP Request Tool | v4.2 | 5 | 데이터 수집 |
| OpenAI Chat Model | v1.2 | 2 | GPT-5 + GPT-4.1-mini |
| Memory Buffer Window | v1.3 | 2 | 대화 기억 |
| Structured Output Parser | v1.3 | 1 | JSON 출력 |
| Slack | v2.3 | 2 | 파일 다운로드 + 메시지 전송 |
| Gmail | v2.1 | 1 | 이메일 발송 |
| Markdown | v1 | 1 | HTML 변환 (미사용) |

**총 노드 수**: 28개

### 외부 API

- **OpenAI GPT-5**: 메인 Agent
- **OpenAI GPT-4.1-mini**: Sub-Agent (KR AI Tool)
- **Tavily Search API**: 뉴스/리서치 검색
- **Tavily Extract API**: Yahoo Finance 크롤링
- **Yahoo Finance**: 재무 데이터 소스 (.KS, .KQ)
- **Slack API**: 메시지 수신/발송, 파일 다운로드
- **Gmail API**: 이메일 발송

### Agent 구조

```
사용자 질문
    ↓
메인 AI Agent (GPT-5)
    ↓
KR AI Tool (GPT-4.1-mini) → 5가지 도구 선택
    ↓
HTTP Request Tools (1~5개 병렬 호출)
    ↓
KR AI Tool (데이터 통합 + 보고서 생성)
    ↓
메인 AI Agent (최종 검토)
    ↓
Structured Output Parser (JSON 변환)
    ↓
Slack + Gmail (동시 발송)
```

**Sub-Agent 구조의 장점**:
- 역할 분리: 메인 Agent는 라우팅, Sub-Agent는 분석
- 모델 최적화: GPT-5(판단) + GPT-4.1-mini(실행)
- 비용 절감: 실행 단계에서 저렴한 모델 사용

## 부록 A: 주요 한국 기업 종목 코드

### IT/반도체
- 삼성전자: 005930
- SK하이닉스: 000660
- 네이버: 035420
- 카카오: 035720
- LG전자: 066570
- LG디스플레이: 034220

### 금융
- KB금융: 105560
- 신한지주: 055550
- 하나금융지주: 086790
- 우리금융지주: 316140
- NH투자증권: 005940

### 자동차
- 현대차: 005380
- 기아: 000270
- 현대모비스: 012330

### 화학/에너지
- LG화학: 051910
- SK이노베이션: 096770
- 롯데케미칼: 011170
- 한화솔루션: 009830

### 바이오/제약
- 삼성바이오로직스: 207940
- 셀트리온: 068270
- 셀트리온헬스케어: 091990
- 유한양행: 000100

### 유통/소비재
- 신세계: 004170
- 롯데쇼핑: 023530
- 현대백화점: 069960
- CJ제일제당: 097950

### 건설
- 삼성물산: 028260
- 현대건설: 000720
- GS건설: 006360

## 부록 B: System Prompt 전체 버전

### 메인 AI Agent

```markdown
# 한국 주식 분석 AI Agent

당신은 한국 주식시장 전문 금융 애널리스트입니다.

**현재 날짜**: {{ $today.format('yyyy-MM-dd') }} (한국시간 KST 기준)

## 핵심 임무

사용자 질문을 분석하여:
1. 종목 코드를 정확히 식별 (삼성전자 → 005930)
2. 필요한 도구만 선별적으로 호출
3. 전략적 통찰이 담긴 투자 보고서를 Markdown 형식으로 작성

## 사용 가능한 도구 (5가지)

### 1. Search (인터넷 검색)
- 최근 뉴스, 급등/급락 이유, CEO 발언, 실적발표
- query: 검색어
- topic: "general" 또는 "news"

### 2. Get Price (주가 히스토리)
- 주가 흐름, 차트, 최근 가격, 변동성
- URL: https://finance.yahoo.com/quote/{ticker}.KS/history/

### 3. Get Income Statement (손익계산서)
- 매출, 순이익, 영업이익, 이익률, 수익성
- URL: https://finance.yahoo.com/quote/{ticker}.KS/financials/

### 4. Get Balance Sheet (대차대조표)
- 자산, 부채, 자본, 유동비율, 부채비율
- URL: https://finance.yahoo.com/quote/{ticker}.KS/balance-sheet/

### 5. Get Cash Flow (현금흐름표)
- FCF, 현금흐름, 현금창출력
- URL: https://finance.yahoo.com/quote/{ticker}.KS/cash-flow/

## 출력 형식 (JSON)
{
  "ticker": "005930",
  "subject": "삼성전자(005930) 2025년 3분기 실적 분석",
  "text": "# 삼성전자(005930) 투자 분석\n\n..."
}

## 중요 규칙
- 한국어 용어: 매출액, 영업이익, 당기순이익
- 금액 단위: 조원, 억원
- Markdown 표 사용 금지 → 불릿 리스트
- 분량: 1,500~2,500자
- 한국 시장 특성 반영 (재벌 구조, 외국인 수급)
```

### KR AI Tool (Sub-Agent)

```markdown
당신은 전문 금융 애널리스트입니다.
오늘 날짜는 {{ $today.format('yyyy-MM-dd') }}입니다.

당신의 임무는 사용자의 질문 의도에 따라 
필요한 데이터만 선별해 전략적 통찰이 담긴 
투자 보고서를 Markdown 형식으로 작성하는 것입니다.

## 사용 가능한 도구:

1. Get Price - 주가, 차트, 흐름, 가격 변동
2. Get Income Statement - 매출, 이익, 수익성
3. Get Balance Sheet - 자산, 부채, 재무 건전성
4. Get Cash Flow - FCF, 현금흐름, 현금창출력
5. Search - 뉴스, 급등 원인, CEO 발언

## 도구 사용 원칙:
- 명시적 키워드 + 문맥 고려
- 불필요한 전 영역 호출 피하기
- 토큰 사용량 최소화

## 출력 구조:
{
  "ticker": "005930",
  "subject": "제목",
  "text": "[Markdown 보고서]"
}
```

## 부록 C: 네이버 금융 크롤링 대안

Yahoo Finance .KS 데이터가 부정확할 경우, 
네이버 금융 크롤링으로 대체 가능합니다.

### 네이버 금융 URL

```
주가: https://finance.naver.com/item/sise_day.nhn?code=005930
재무제표: https://finance.naver.com/item/main.nhn?code=005930
투자지표: https://finance.naver.com/item/main.nhn?code=005930
외국인/기관: https://finance.naver.com/item/frgn.nhn?code=005930
```

### 도구 수정 방법

**KR Get Price 수정 예시**:
```json
{
  "urls": "{{ $fromAI('url','https://finance.naver.com/item/sise_day.nhn?code={ticker}') }}",
  "include_images": false,
  "extract_depth": "basic"
}
```

**장점**:
- 더 정확한 한국 데이터
- 실시간 주가 정보
- 외국인/기관 수급 정보

**단점**:
- 페이지 구조 복잡
- 크롤링 안정성 낮음
- Tavily Extract의 정확도 의존

## 부록 D: DART API 연동 방안

금융감독원 전자공시시스템 DART API를 연동하면 
공식 공시 정보를 자동으로 수집할 수 있습니다.

### DART API 개요

- **공식 사이트**: https://opendart.fss.or.kr/
- **API KEY**: 무료 발급 (회원가입 필요)
- **제공 정보**: 사업보고서, 분기보고서, 감사보고서

### 활용 방법

1. **실적 발표 자동 수집**:
   ```
   /api/fnlttSinglAcnt.json
   → 재무제표 주요 계정 조회
   ```

2. **공시 검색**:
   ```
   /api/list.json
   → 최근 공시 리스트 조회
   ```

3. **사업보고서 조회**:
   ```
   /api/document.json
   → 사업보고서 원문 다운로드
   ```

### HTTP Request Tool 추가

```json
{
  "tool_description": "DART API로 공시 정보 조회",
  "method": "GET",
  "url": "https://opendart.fss.or.kr/api/fnlttSinglAcnt.json",
  "parameters": {
    "crtfc_key": "{{ $fromAI('api_key','YOUR_DART_API_KEY') }}",
    "corp_code": "{{ $fromAI('corp_code','00126380') }}",
    "bsns_year": "2025",
    "reprt_code": "11013"
  }
}
```

## 부록 E: 51.json, 52.json, 53.json 비교

### 51.json (Multi-Agent)
- **특징**: 한국 + 미국 통합
- **노드 수**: 42개
- **Agent**: 3개 (라우터 + KR + USA)
- **모델**: GPT-5 + GPT-4.1-mini
- **장점**: 글로벌 커버리지
- **단점**: 복잡한 구조

### 52.json (USA Single Agent)
- **특징**: 미국 전용
- **노드 수**: 25개
- **Agent**: 1개 (USA 전문)
- **모델**: GPT-5
- **장점**: 단순한 구조
- **단점**: 미국만 지원

### 53.json (KR Agent + Sub-Agent)
- **특징**: 한국 전용
- **노드 수**: 28개
- **Agent**: 2개 (메인 + Sub)
- **모델**: GPT-5 + GPT-4.1-mini
- **장점**: 비용 최적화
- **단점**: 한국만 지원

### 선택 가이드

**53.json을 선택해야 하는 경우**:
- 한국 시장만 투자
- 비용 효율성 중요
- Sub-Agent 구조 학습

**52.json을 선택해야 하는 경우**:
- 미국 시장만 투자
- 단순한 구조 선호

**51.json을 선택해야 하는 경우**:
- 한국 + 미국 동시 투자
- 글로벌 포트폴리오
- 자동 시장 구분 필요

## 부록 F: 실전 활용 사례

### 사례 1: 장전 체크

**시나리오**: 개장 전 보유 종목 점검

**활용법**:
```
(08:30) "삼성전자 전일 동향"
(08:35) "SK하이닉스 뉴스 확인"
(08:40) "네이버 주가 흐름"
```

**효과**:
- 개장 전 정보 파악
- 매매 전략 수립
- 리스크 사전 파악

### 사례 2: 급등/급락 대응

**시나리오**: 장중 급등/급락 종목 분석

**활용법**:
```
(10:30) "SK하이닉스 급등 이유는?"
→ 뉴스 + 주가 + 재무 종합 분석

(14:00) "삼성전자 급락 원인"
→ 실시간 뉴스 + 수급 분석
```

**효과**:
- 빠른 의사결정
- 감정적 매매 방지
- 기회 포착

### 사례 3: 주말 리서치

**시나리오**: 주말에 다음 주 투자 종목 선정

**활용법**:
```
(토요일 오전)
"삼성전자 재무 안정성"
"SK하이닉스 현금흐름 분석"
"네이버 실적 추이"
"카카오 밸류에이션"
```

**효과**:
- 심도 있는 분석
- 여러 종목 비교
- 투자 아이디어 발굴

### 사례 4: 투자 스터디 그룹

**시나리오**: Slack 채널에서 공동 리서치

**활용법**:
```
채널: #stock-study

Member A: "이번 주 추천 종목은?"
Bot: "삼성전자 분석 중..."

Member B: "@bot SK하이닉스는?"
Bot: "SK하이닉스 분석 중..."
```

**효과**:
- 지식 공유
- 다양한 관점
- 학습 효과

## 부록 G: 비용 최적화 전략

### API 비용 구조

**OpenAI**:
- GPT-5: Input $10/1M tokens, Output $30/1M tokens
- GPT-4.1-mini: Input $0.3/1M tokens, Output $1.2/1M tokens

**Tavily**:
- Search: $0.005/request
- Extract: $0.002/request

### 월간 예상 비용 (하루 10회 분석 기준)

**시나리오 1: 단순 분석 (2개 도구)**
- OpenAI GPT-5: ~$2
- OpenAI GPT-4.1-mini: ~$0.5
- Tavily: ~$2
- **총합**: ~$4.5/월

**시나리오 2: 종합 분석 (4개 도구)**
- OpenAI GPT-5: ~$3
- OpenAI GPT-4.1-mini: ~$1
- Tavily: ~$4
- **총합**: ~$8/월

### 비용 절감 팁

1. **캐싱 활용**:
   - 동일 종목 중복 호출 방지
   - 최근 조회 결과 재사용 (15분 이내)

2. **도구 선택 최적화**:
   - 필요한 도구만 호출
   - 주가만 확인 시 Get Price만 사용

3. **배치 처리**:
   - 여러 질문을 한 번에 처리
   - "삼성전자, SK하이닉스, 네이버 분석"

4. **Sub-Agent 활용**:
   - 메인: GPT-5 (판단)
   - Sub: GPT-4.1-mini (실행)
   - 비용 50% 절감

## 부록 H: 라이선스 및 주의사항

### API 라이선스

- **OpenAI**: 상업적 사용 가능 (API 약관 준수)
- **Tavily**: 상업적 사용 가능 (플랜별 제한)
- **Yahoo Finance**: 비상업적 용도 권장 (공식 API 없음)
- **Slack**: Bot 사용 약관 준수
- **Gmail**: API 사용 가이드라인 준수

### 법적 주의사항

1. **투자 조언 아님**: 이 시스템은 정보 제공 목적이며, 공식 투자 자문이 아닙니다.
2. **데이터 정확성**: 크롤링 데이터의 정확성을 보장하지 않습니다.
3. **투자 책임**: 모든 투자 결정은 본인 책임입니다.
4. **저작권**: 생성된 콘텐츠의 저작권은 사용자에게 있습니다.

### 윤리적 사용

- 과도한 API 호출 자제
- 개인정보 보호
- 공정한 정보 공유
- 시장 조작 금지
- 허위 정보 유포 금지

### 한국 금융 관련 규정

- **자본시장법**: 미공개 정보 이용 금지
- **공정거래법**: 시세 조종 금지
- **개인정보보호법**: 투자 정보 보호

## 결론

이 워크플로우는 Slack 기반의 간편한 인터페이스를 통해 
**한국 상장 기업의 재무 분석을 자동화**합니다.

**핵심 장점**:
- 🇰🇷 한국 시장 특화: 코스피/코스닥 전문
- 🤖 Sub-Agent 구조: 비용 효율적
- 📊 종합 분석: 재무제표 + 뉴스 + 주가
- 💬 편리한 UX: Slack 텍스트/음성 지원
- 📧 자동 발송: Slack + Gmail 동시 전송

**활용 시나리오**:
- 개인 투자자의 종목 분석
- 투자 동호회의 공유 도구
- 애널리스트의 리서치 보조
- 금융 교육 자료

**다음 단계**:
- 네이버 금융 API 연동
- DART 공시 자동 수집
- 차트 시각화
- 포트폴리오 추적
- 미국 시장 추가 → Multi-Agent (51.json)

## 참고 자료

- [n8n 공식 문서](https://docs.n8n.io/)
- [OpenAI API 문서](https://platform.openai.com/docs)
- [Tavily API 문서](https://docs.tavily.com/)
- [Yahoo Finance](https://finance.yahoo.com/)
- [네이버 금융](https://finance.naver.com/)
- [금융감독원 DART](https://dart.fss.or.kr/)
- [Slack API 문서](https://api.slack.com/)

---

📄 **JSON 워크플로우 파일**: `53.json`  
🏢 **대상 시장**: 한국 코스피/코스닥 상장 기업  
📊 **전체 노드 수**: 28개  
🤖 **AI Model**: OpenAI GPT-5 + GPT-4.1-mini  
🔧 **데이터 수집 도구**: 5개  
💰 **예상 비용**: ~$5~8/월 (하루 10회 기준)  

**마지막 업데이트**: 2025년 10월 11일  
**작성자**: n8n Community  
**버전**: 1.0  
**워크플로우 ID**: dHl5FkMqIGvogqVD